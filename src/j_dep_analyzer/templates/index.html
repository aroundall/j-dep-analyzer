{% extends "base.html" %}
{% block content %}
<div class="grid grid-cols-1 gap-6">
  <section class="bg-white border rounded-sm p-4 shadow-sm border-[#E5E5E5]">
    <h2 class="font-semibold mb-2">Upload POM(s)</h2>

    <form
      id="upload-form"
      class="flex flex-col gap-3"
      hx-post="/api/upload"
      hx-encoding="multipart/form-data"
      hx-target="#upload-status"
      hx-swap="innerHTML"
      hx-indicator="#upload-indicator"
      hx-on:htmx:beforeRequest="document.getElementById('upload-status').innerHTML = 'Uploading…';"
      hx-on:htmx:afterRequest="if(event.detail.successful){window.reloadGraph && window.reloadGraph()}"
      hx-on:htmx:responseError="document.getElementById('upload-status').innerHTML = event.detail.xhr.responseText;"
    >
      <div
        id="dropzone"
        class="relative w-full rounded-sm border border-dashed border-[#E5E5E5] bg-[#F3F3F3] px-4 py-6 text-sm text-[#333333]"
      >
        <input
          id="file-input"
          class="absolute inset-0 h-full w-full opacity-0 cursor-pointer"
          type="file"
          name="files"
          multiple
        />
        <div class="text-center">
          <div class="font-medium">Drag & drop pom.xml file(s) here</div>
          <div class="text-xs text-[#767676] mt-1">or click to select multiple files</div>
          <div id="selected-files" class="text-xs text-[#767676] mt-2"></div>
        </div>
      </div>

      <div class="flex items-center gap-3">
        <button class="px-3 py-2 text-sm ql-btn ql-btn-primary" type="submit">Upload</button>
        <div id="upload-indicator" class="htmx-indicator text-xs text-[#767676]">Uploading…</div>
        <div class="text-xs text-[#767676]">Upload parses and upserts into SQLite.</div>
      </div>
    </form>

    <div id="upload-status" class="mt-3 text-sm text-[#333333]"></div>
    <div class="mt-2 text-xs text-[#767676]">DB: {{ db_path }}</div>
  </section>

  <section class="bg-white border rounded-sm p-4 shadow-sm border-[#E5E5E5]">
    <div class="flex flex-wrap items-center gap-4 mb-3">
      <label class="flex items-center gap-2 text-sm">
        <input id="show-group" type="checkbox" class="accent-[#0090F1]" {% if show_group %}checked{% endif %} />
        <span>Show Group</span>
      </label>

      <label class="flex items-center gap-2 text-sm">
        <input id="show-version" type="checkbox" class="accent-[#0090F1]" {% if show_version %}checked{% endif %} />
        <span>Show Version</span>
      </label>

      <label class="text-sm">
        <span class="mr-2 text-[#767676]">Direction</span>
        <select id="direction" class="border rounded-sm px-2 py-1 text-sm bg-white border-[#E5E5E5]">
          <option value="forward" selected>A depends on B</option>
          <option value="reverse">Who depends on B</option>
        </select>
      </label>

      <label class="text-sm">
        <span class="mr-2 text-[#767676]">Depth</span>
        <select id="depth" class="border rounded-sm px-2 py-1 text-sm bg-white border-[#E5E5E5]">
          <option value="">All</option>
          <option value="1">1</option>
          <option value="2" selected>2</option>
        </select>
      </label>

      <label class="text-sm">
        <span class="mr-2 text-[#767676]">Layout</span>
        <select id="layout" class="border rounded-sm px-2 py-1 text-sm bg-white border-[#E5E5E5]">
          <option value="dagre">dagre</option>
          <option value="circle">circle</option>
          <option value="concentric" selected>concentric</option>
          <option value="cose">cose</option>
        </select>
      </label>
    </div>

    <div id="cy" class="w-full border rounded-sm border-[#E5E5E5]" style="height: 720px;"></div>
    <div id="meta" class="mt-2 text-xs text-[#767676]"></div>
  </section>
</div>

<script>
  cytoscape.use(cytoscapeDagre);

  const cy = cytoscape({
    container: document.getElementById("cy"),
    elements: [],
    minZoom: 0.45,
    maxZoom: 4.0,
    wheelSensitivity: 0.12,
    style: [
      { selector: "node", style: {
        "label": "data(label)",
        "background-color": "#BDBDBD",
        "color": "#333333",
        "text-valign": "center",
        "text-halign": "center",
        "font-size": "10px",
        "width": 18,
        "height": 18,
      }},
      { selector: "node.aggregated", style: {
        "shape": "round-rectangle",
        "width": 28,
        "height": 18,
        "background-color": "#D7D7D7",
      }},
      { selector: "node.root", style: { "background-color": "#0090F1" } },
      { selector: "node.highlight", style: { "background-color": "#800080" } },
      { selector: "edge", style: {
        "curve-style": "bezier",
        "target-arrow-shape": "triangle",
        "target-arrow-color": "#BDBDBD",
        "line-color": "#E5E5E5",
        "width": 1,
        "label": "data(scope)",
        "font-size": "8px",
        "text-rotation": "autorotate",
        "color": "#767676"
      }},
    ],
  });

  function buildParams() {
    const showGroup = document.getElementById("show-group").checked;
    const showVersion = document.getElementById("show-version").checked;
    const direction = document.getElementById("direction").value;
    const depthVal = document.getElementById("depth").value;

    const p = new URLSearchParams();
    p.set("show_group", String(showGroup));
    p.set("show_version", String(showVersion));
    p.set("direction", direction);
    if (depthVal) p.set("depth", depthVal);
    return p.toString();
  }

  function runLayout() {
    const layoutName = document.getElementById("layout").value;
    let opts;
    if (layoutName === "dagre") {
      opts = { name: "dagre", rankDir: "LR", nodeSep: 30, edgeSep: 10, rankSep: 60, fit: false };
    } else if (layoutName === "circle") {
      opts = {
        name: "circle",
        fit: false,
        padding: 90,
        avoidOverlap: true,
        nodeOverlap: 10,
        spacingFactor: 1.8,
      };
    } else if (layoutName === "concentric") {
      opts = {
        name: "concentric",
        fit: false,
        padding: 90,
        avoidOverlap: true,
        nodeOverlap: 10,
        spacingFactor: 1.6,
        minNodeSpacing: 20,
        levelWidth: () => 1,
      };
    } else {
      opts = {
        name: "cose",
        animate: false,
        randomize: true,
        fit: false,
        padding: 90,
        numIter: 2000,
        nodeRepulsion: 52000,
        nodeOverlap: 10,
        idealEdgeLength: 180,
        edgeElasticity: 0.2,
        gravity: 0.15,
        componentSpacing: 200,
      };
    }

    const layout = cy.layout(opts);
    layout.on('layoutstop', () => {
      // Fit only after layout finishes; otherwise all nodes can be at (0,0)
      // and Cytoscape will zoom to the maximum, making everything unreadable.
      cy.fit(undefined, 70);

      const z = cy.zoom();
      const minZ = cy.minZoom();
      const maxZ = cy.maxZoom();
      const preferredMaxInitialZoom = Math.min(1.25, maxZ);

      if (z < minZ) cy.zoom(minZ);
      if (z > preferredMaxInitialZoom) cy.zoom(preferredMaxInitialZoom);
      cy.center();
    });
    layout.run();
  }

  window.reloadGraph = async function() {
    const res = await fetch(`/api/graph/data?${buildParams()}`);
    const payload = await res.json();

    cy.elements().remove();
    cy.add(payload.elements);
    runLayout();

    document.getElementById("meta").textContent =
      `nodes=${payload.meta.node_count}, edges=${payload.meta.edge_count}, show_group=${payload.meta.show_group}, show_version=${payload.meta.show_version}, direction=${payload.meta.direction}, depth=${payload.meta.depth ?? "All"}`;
  };

  document.getElementById("show-group").addEventListener("change", window.reloadGraph);
  document.getElementById("show-version").addEventListener("change", window.reloadGraph);
  document.getElementById("direction").addEventListener("change", window.reloadGraph);
  document.getElementById("depth").addEventListener("change", window.reloadGraph);
  document.getElementById("layout").addEventListener("change", runLayout);

  window.reloadGraph();
</script>

<script>
  (function() {
    const dz = document.getElementById('dropzone');
    const input = document.getElementById('file-input');
    const list = document.getElementById('selected-files');
    const form = document.getElementById('upload-form');

    function renderSelected() {
      if (!input.files || input.files.length === 0) {
        list.textContent = '';
        return;
      }
      const names = Array.from(input.files).map(f => f.name);
      list.textContent = names.join(', ');
    }

    dz.addEventListener('dragover', (e) => {
      e.preventDefault();
    });

    dz.addEventListener('drop', (e) => {
      e.preventDefault();
      if (e.dataTransfer && e.dataTransfer.files) {
        input.files = e.dataTransfer.files;
        renderSelected();
      }
    });

    input.addEventListener('change', renderSelected);
  })();
</script>
{% endblock %}
