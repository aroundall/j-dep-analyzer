{% extends "base.html" %}
{% block content %}
<section class="bg-white border rounded-sm p-4 shadow-sm border-[#E5E5E5]">
  <h2 class="font-semibold mb-3">Dependencies (Pair List)</h2>

  <div class="flex flex-wrap items-center gap-3 mb-3">
    <input
      id="dep-q"
      class="border rounded-sm px-3 py-2 w-full md:w-96 text-sm bg-white border-[#E5E5E5]"
      type="text"
      name="q"
      placeholder="Filter by ArtifactId..."
      hx-get="/partials/dependencies-table"
      hx-trigger="keyup changed delay:300ms"
      hx-target="#dep-table"
      hx-include="[name='q'],[name='group_q'],[name='scope'],[name='ignore_version'],[name='ignore_group']"
    />

    <input
      id="dep-group-q"
      class="border rounded-sm px-3 py-2 w-full md:w-80 text-sm bg-white border-[#E5E5E5]"
      type="text"
      name="group_q"
      placeholder="Filter by GroupId..."
      hx-get="/partials/dependencies-table"
      hx-trigger="keyup changed delay:300ms"
      hx-target="#dep-table"
      hx-include="[name='q'],[name='group_q'],[name='scope'],[name='ignore_version'],[name='ignore_group']"
    />

    <select
      id="dep-scope"
      name="scope"
      multiple
      class="border rounded-sm px-3 py-2 text-sm bg-white w-full md:w-72 border-[#E5E5E5]"
      hx-get="/partials/dependencies-table"
      hx-trigger="change"
      hx-target="#dep-table"
      hx-include="[name='q'],[name='group_q'],[name='scope'],[name='ignore_version'],[name='ignore_group']"
    >
      {% for s in scopes or [] %}
        <option value="{{ s }}">{{ s }}</option>
      {% endfor %}
    </select>

    <label class="flex items-center gap-2 text-sm">
      <input
        id="dep-ignore-version"
        type="checkbox"
        name="ignore_version"
        class="accent-[#0090F1]"
        hx-get="/partials/dependencies-table"
        hx-trigger="change"
        hx-target="#dep-table"
        hx-include="[name='q'],[name='group_q'],[name='scope'],[name='ignore_version'],[name='ignore_group']"
      />
      <span>Ignore Version</span>
    </label>

    <label class="flex items-center gap-2 text-sm">
      <input
        id="dep-ignore-group"
        type="checkbox"
        name="ignore_group"
        class="accent-[#0090F1]"
        hx-get="/partials/dependencies-table"
        hx-trigger="change"
        hx-target="#dep-table"
        hx-include="[name='q'],[name='group_q'],[name='scope'],[name='ignore_version'],[name='ignore_group']"
      />
      <span>Ignore GroupId</span>
    </label>

    <a
      id="export-csv"
      class="px-3 py-2 text-sm ql-btn"
      href="/api/dependencies/export"
    >Export CSV</a>
  </div>

  <div
    id="dep-table"
    hx-get="/partials/dependencies-table"
    hx-trigger="load"
    hx-include="[name='q'],[name='group_q'],[name='scope'],[name='ignore_version'],[name='ignore_group']"
    hx-swap="innerHTML"
  ></div>

  <div class="mt-2 text-xs text-[#767676]">DB: {{ db_path }}</div>
</section>

<script>
  (function() {
    const q = document.getElementById('dep-q');
    const gq = document.getElementById('dep-group-q');
    const scopeSel = document.getElementById('dep-scope');
    const iv = document.getElementById('dep-ignore-version');
    const ig = document.getElementById('dep-ignore-group');
    const link = document.getElementById('export-csv');

    function update() {
      const p = new URLSearchParams();
      if (q && q.value) p.set('q', q.value);
      if (gq && gq.value) p.set('group_q', gq.value);

      if (scopeSel) {
        const selected = Array.from(scopeSel.selectedOptions || []).map(o => o.value).filter(Boolean);
        for (const s of selected) p.append('scope', s);
      }

      if (iv && iv.checked) p.set('ignore_version', 'true');
      if (ig && ig.checked) p.set('ignore_group', 'true');
      link.href = `/api/dependencies/export?${p.toString()}`;
    }

    q && q.addEventListener('input', update);
    gq && gq.addEventListener('input', update);
    scopeSel && scopeSel.addEventListener('change', update);
    iv && iv.addEventListener('change', update);
    ig && ig.addEventListener('change', update);
    update();
  })();
</script>
{% endblock %}
