{% extends "base.html" %}

{% block content %}
<div class="flex flex-col lg:flex-row gap-6 h-[calc(100vh-8rem)]">

  <!-- Sidebar: Controls & Info -->
  <div class="w-full lg:w-80 flex-shrink-0 flex flex-col gap-6 overflow-y-auto pr-2 custom-scrollbar">

    <!-- Back Link -->
    <a href="/dependencies/list"
      class="flex items-center gap-1 text-sm text-gray-500 hover:text-primary-600 transition-colors">
      <span class="material-symbols-outlined text-sm">arrow_back</span>
      Back to List
    </a>

    <!-- Artifact Info Card -->
    <div class="bg-surface rounded-xl shadow-mate-1 border border-gray-100 p-6">
      <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-4">Focused Artifact</h3>

      <div class="space-y-4">
        <div>
          <label class="text-xs text-gray-400">Artifact ID</label>
          <div class="font-bold text-gray-900 text-lg break-words">{{ root_artifact }}</div>
        </div>

        <div>
          <label class="text-xs text-gray-400">Group ID</label>
          <div class="font-mono text-sm text-primary-600 break-all bg-primary-50 px-2 py-1 rounded inline-block mt-1">{{
            root_group }}</div>
        </div>

        <div>
          <label class="text-xs text-gray-400">Version</label>
          <div class="font-mono text-sm text-gray-700 bg-gray-100 px-2 py-1 rounded inline-block mt-1">{{ root_version
            }}</div>
        </div>
      </div>
    </div>

    <!-- Controls Card -->
    <div class="bg-surface rounded-xl shadow-mate-1 border border-gray-100 p-6 flex-grow">
      <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-4">Graph Settings</h3>

      <form id="graph-controls" class="space-y-6">

        <!-- Depth -->
        <div>
          <label class="block text-sm font-medium text-gray-900 mb-2">Search Depth</label>
          <input type="range" id="depth" min="1" max="5" value="2"
            class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-primary-600">
          <div class="flex justify-between text-xs text-gray-500 mt-1">
            <span>1</span><span>2</span><span>3</span><span>4</span><span>5</span>
          </div>
        </div>

        <!-- Direction -->
        <div>
          <label class="block text-sm font-medium text-gray-900 mb-2">Direction</label>
          <div class="flex rounded-lg shadow-sm border border-gray-200 overflow-hidden">
            <label class="flex-1 cursor-pointer">
              <input type="radio" name="direction" value="forward" checked class="peer sr-only">
              <span
                class="block text-center py-2 text-sm bg-gray-50 peer-checked:bg-primary-600 peer-checked:text-white transition-colors">Depend
                on</span>
            </label>
            <label class="flex-1 cursor-pointer border-l border-gray-200">
              <input type="radio" name="direction" value="reverse" class="peer sr-only">
              <span
                class="block text-center py-2 text-sm bg-gray-50 peer-checked:bg-primary-600 peer-checked:text-white transition-colors">Make
                use of</span>
            </label>
          </div>
        </div>

        <!-- Toggles -->
        <div class="space-y-2">
          <label class="flex items-center gap-2 cursor-pointer">
            <input type="checkbox" id="show-group"
              class="rounded border-gray-300 text-primary-600 focus:ring-primary-500">
            <span class="text-sm text-gray-900">Show Group IDs</span>
          </label>
          <label class="flex items-center gap-2 cursor-pointer">
            <input type="checkbox" id="show-version"
              class="rounded border-gray-300 text-primary-600 focus:ring-primary-500">
            <span class="text-sm text-gray-900">Show Versions</span>
          </label>
        </div>

        <!-- Layout Selector -->
        <div>
          <label class="block text-sm font-medium text-gray-900 mb-2">Layout</label>
          <select id="layout-select"
            class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5">
            <option value="dagre" selected>Hierarchy (Dagre)</option>
            <option value="cose">Force (Cose)</option>
            <option value="grid">Grid</option>
            <option value="circle">Circle</option>
            <option value="concentric">Concentric</option>
            <option value="breadthfirst">Breadthfirst</option>
          </select>
        </div>

        <button type="button" onclick="loadGraph()"
          class="w-full ripple bg-primary-600 hover:bg-primary-700 text-white font-medium py-2 px-4 rounded-lg shadow-sm shadow-primary-500/30 transition-all">
          Update Graph
        </button>
      </form>
    </div>
  </div>

  <!-- Main: Graph Canvas -->
  <div
    class="flex-grow bg-surface rounded-xl shadow-mate-1 border border-gray-100 relative overflow-hidden flex flex-col">
    <div class="absolute top-4 left-4 z-10 flex gap-2">
      <div
        class="bg-white/80 backdrop-blur px-3 py-1 rounded-full border border-gray-200 text-xs text-gray-500 shadow-sm">
        <span id="node-count">0</span> Nodes
      </div>
      <div
        class="bg-white/80 backdrop-blur px-3 py-1 rounded-full border border-gray-200 text-xs text-gray-500 shadow-sm">
        <span id="edge-count">0</span> Edges
      </div>
    </div>

    <div id="cy" class="w-full h-full bg-slate-50"></div>
  </div>

</div>

<script>
  var cy;
  const rootId = "{{ root_id }}"; // Server injected

  document.addEventListener('DOMContentLoaded', function () {
    loadGraph();
  });

  function loadGraph() {
    // Collect params
    const direction = document.querySelector('input[name="direction"]:checked').value;
    const depth = document.getElementById('depth').value;
    const showGroup = document.getElementById('show-group').checked;
    const showVersion = document.getElementById('show-version').checked;

    const url = `/api/graph/data?root_id=${encodeURIComponent(rootId)}&direction=${direction}&depth=${depth}&show_group=${showGroup}&show_version=${showVersion}`;

    // Show loading state if needed (optional)

    fetch(url)
      .then(res => res.json())
      .then(data => {
        document.getElementById('node-count').innerText = data.meta.node_count;
        document.getElementById('edge-count').innerText = data.meta.edge_count;
        initCy(data.elements);
      });
  }

  function initCy(elements) {
    if (cy) cy.destroy();

    cy = cytoscape({
      container: document.getElementById('cy'),
      elements: elements,
      minZoom: 0.1,
      maxZoom: 3,
      wheelSensitivity: 0.3,
      style: [
        {
          selector: 'node',
          style: {
            'background-color': '#fff',
            'border-width': 1,
            'border-color': '#cbd5e1',
            'label': 'data(label)',
            'color': '#334155',
            'font-size': '12px',
            'font-family': 'Inter, sans-serif',
            'text-valign': 'center',
            'text-halign': 'center',
            'width': 'label',
            'height': 'label',
            'padding': '16px',
            'shape': 'round-rectangle',
            'text-max-width': '200px',
            'text-wrap': 'wrap'
          }
        },
        {
          selector: 'node[id = "' + rootId + '"]',
          style: {
            'background-color': '#e0e7ff', // Primary 100
            'border-color': '#6366f1', // Primary 500
            'border-width': 2,
            'color': '#4338ca',
            'font-weight': 'bold'
          }
        },
        {
          selector: 'edge',
          style: {
            'width': 1.5,
            'line-color': '#94a3b8',
            'target-arrow-color': '#94a3b8',
            'target-arrow-shape': 'triangle',
            'curve-style': 'bezier',
            'arrow-scale': 1.2
          }
        }
      ],
      layout: {
        name: document.getElementById('layout-select').value,
        rankDir: 'LR',
        animate: true,
        animationDuration: 500,
        padding: 50,
        stop: function () {
          cy.fit(undefined, 50);
        }
      }
    });

    cy.on('tap', 'node', function (evt) {
      var node = evt.target;
      const id = node.id();
      if (id && id !== rootId) {
        window.location.href = `/visualize/${encodeURIComponent(id)}`;
      }
    });
  }
</script>
{% endblock %}