{% extends "base.html" %}
{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-4 gap-4">
  <section class="bg-white border rounded-sm p-4 shadow-sm border-[#E5E5E5] lg:col-span-1">
    <div class="text-sm text-[#767676]">Selected</div>
    <div class="mt-1 font-mono text-sm break-all">{{ root_id }}</div>

    <div class="mt-4 text-sm">
      <div class="flex justify-between gap-3"><span class="text-[#767676]">Group</span><span class="font-mono text-sm">{{ root_group }}</span></div>
      <div class="flex justify-between gap-3"><span class="text-[#767676]">Artifact</span><span class="font-mono text-sm">{{ root_artifact }}</span></div>
      <div class="flex justify-between gap-3"><span class="text-[#767676]">Version</span><span class="font-mono text-sm">{{ root_version }}</span></div>
    </div>

    <div class="mt-4 text-xs text-[#767676]">DB: {{ db_path }}</div>
  </section>

  <section class="bg-white border rounded-sm p-4 shadow-sm border-[#E5E5E5] lg:col-span-3">
    <div class="flex flex-wrap items-center justify-between gap-3 mb-3">
      <div class="text-sm font-medium">Dependency View</div>

      <div class="flex flex-wrap items-center gap-4">
        <label class="flex items-center gap-2 text-sm">
          <input id="show-group" type="checkbox" class="accent-[#0090F1]" {% if show_group %}checked{% endif %} />
          <span>Show Group</span>
        </label>

        <label class="flex items-center gap-2 text-sm">
          <input id="show-version" type="checkbox" class="accent-[#0090F1]" {% if show_version %}checked{% endif %} />
          <span>Show Version</span>
        </label>

        <label class="text-sm">
          <span class="mr-2 text-[#767676]">Scope</span>
          <select id="scope" class="border rounded-sm px-2 py-1 text-sm bg-white border-[#E5E5E5]" multiple>
            {% for s in scopes or [] %}
              <option value="{{ s }}" {% if selected_scopes and (s in selected_scopes) %}selected{% endif %}>{{ s }}</option>
            {% endfor %}
          </select>
        </label>

        <label class="text-sm">
          <span class="mr-2 text-[#767676]">Direction</span>
          <select id="direction" class="border rounded-sm px-2 py-1 text-sm bg-white border-[#E5E5E5]">
            <option value="forward" selected>Forward</option>
            <option value="reverse">Reverse</option>
          </select>
        </label>

        <label class="text-sm">
          <span class="mr-2 text-[#767676]">Depth</span>
          <select id="depth" class="border rounded-sm px-2 py-1 text-sm bg-white border-[#E5E5E5]">
            <option value="">All</option>
            <option value="1">1</option>
            <option value="2" selected>2</option>
          </select>
        </label>

        <label class="text-sm">
          <span class="mr-2 text-[#767676]">Layout</span>
          <select id="layout" class="border rounded-sm px-2 py-1 text-sm bg-white border-[#E5E5E5]">
            <option value="dagre">dagre</option>
            <option value="circle">circle</option>
            <option value="concentric" selected>concentric</option>
            <option value="cose">cose</option>
          </select>
        </label>
      </div>
    </div>

    <div id="cy" class="w-full border rounded-sm border-[#E5E5E5]" style="height: 720px;"></div>
    <div id="meta" class="mt-2 text-xs text-[#767676]"></div>
  </section>
</div>

<script>
  cytoscape.use(cytoscapeDagre);

  const ROOT_ID = {{ root_id | tojson }};

  const cy = cytoscape({
    container: document.getElementById("cy"),
    elements: [],
    minZoom: 0.45,
    maxZoom: 4.0,
    wheelSensitivity: 0.12,
    style: [
      { selector: "node", style: {
        "label": "data(label)",
        "background-color": "#BDBDBD",
        "color": "#333333",
        "text-valign": "center",
        "text-halign": "center",
        "font-size": "10px",
        "width": 18,
        "height": 18,
      }},
      { selector: "node.aggregated", style: {
        "shape": "round-rectangle",
        "width": 28,
        "height": 18,
        "background-color": "#D7D7D7",
      }},
      { selector: "node.root", style: { "background-color": "#0090F1" } },
      { selector: "node.highlight", style: { "background-color": "#800080" } },
      { selector: "edge", style: {
        "curve-style": "bezier",
        "target-arrow-shape": "triangle",
        "target-arrow-color": "#BDBDBD",
        "line-color": "#E5E5E5",
        "width": 1,
        "label": "data(scope)",
        "font-size": "8px",
        "text-rotation": "autorotate",
        "color": "#767676"
      }},
    ],
  });

  function buildParams() {
    const showGroup = document.getElementById("show-group").checked;
    const showVersion = document.getElementById("show-version").checked;
    const scopeSel = document.getElementById("scope");
    const direction = document.getElementById("direction").value;
    const depthVal = document.getElementById("depth").value;

    const p = new URLSearchParams();
    p.set("root_id", ROOT_ID);
    p.set("show_group", String(showGroup));
    p.set("show_version", String(showVersion));
    if (scopeSel) {
      const selected = Array.from(scopeSel.selectedOptions || []).map(o => o.value).filter(Boolean);
      for (const s of selected) p.append("scope", s);
    }
    p.set("direction", direction);
    if (depthVal) p.set("depth", depthVal);
    return p.toString();
  }

  function runLayout() {
    const layoutName = document.getElementById("layout").value;
    let opts;
    if (layoutName === "dagre") {
      opts = { name: "dagre", rankDir: "LR", nodeSep: 30, edgeSep: 10, rankSep: 60, fit: false };
    } else if (layoutName === "circle") {
      opts = {
        name: "circle",
        fit: false,
        padding: 90,
        avoidOverlap: true,
        nodeOverlap: 10,
        spacingFactor: 1.8,
      };
    } else if (layoutName === "concentric") {
      opts = {
        name: "concentric",
        fit: false,
        padding: 90,
        avoidOverlap: true,
        nodeOverlap: 10,
        spacingFactor: 1.6,
        minNodeSpacing: 20,
        levelWidth: () => 1,
      };
    } else {
      opts = {
        name: "cose",
        animate: false,
        randomize: true,
        fit: false,
        padding: 90,
        numIter: 2000,
        nodeRepulsion: 52000,
        nodeOverlap: 10,
        idealEdgeLength: 180,
        edgeElasticity: 0.2,
        gravity: 0.15,
        componentSpacing: 200,
      };
    }

    const layout = cy.layout(opts);
    layout.on('layoutstop', () => {
      cy.fit(undefined, 70);

      const z = cy.zoom();
      const minZ = cy.minZoom();
      const maxZ = cy.maxZoom();
      const preferredMaxInitialZoom = Math.min(1.25, maxZ);

      if (z < minZ) cy.zoom(minZ);
      if (z > preferredMaxInitialZoom) cy.zoom(preferredMaxInitialZoom);
      cy.center();
    });
    layout.run();
  }

  async function reloadGraph() {
    const res = await fetch(`/api/graph/data?${buildParams()}`);
    const payload = await res.json();

    cy.elements().remove();
    cy.add(payload.elements);
    runLayout();

    document.getElementById("meta").textContent =
      `nodes=${payload.meta.node_count}, edges=${payload.meta.edge_count}, direction=${payload.meta.direction}, depth=${payload.meta.depth ?? "All"}`;
  }

  document.getElementById("show-group").addEventListener("change", reloadGraph);
  document.getElementById("show-version").addEventListener("change", reloadGraph);
  const scopeEl = document.getElementById("scope");
  scopeEl && scopeEl.addEventListener("change", reloadGraph);
  document.getElementById("direction").addEventListener("change", reloadGraph);
  document.getElementById("depth").addEventListener("change", reloadGraph);
  document.getElementById("layout").addEventListener("change", runLayout);

  reloadGraph();
</script>
{% endblock %}
